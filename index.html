<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>μCritAir WebDFU</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="sakura.css" />
  <style>
    :root {
      --ucritter-primary: #673de6;
      --ucritter-accent: #ff5b8d;
      --ucritter-bg: #fdfdfd;
    }
    body {
      background: var(--ucritter-bg);
      max-width: 44rem;
      margin: 0 auto;
      padding: 1rem;
      font-family: system-ui, -apple-system, "Helvetica Neue", Arial, sans-serif;
    }
    .hero {
      text-align: center;
      padding: 2rem 1rem 1rem;
    }
    .hero h1 {
      font-size: 2.5rem;
      color: var(--ucritter-primary);
      margin-bottom: 0.25rem;
    }
    .hero .tagline {
      font-size: 1.2rem;
      color: #555;
    }
    .instructions {
      border-left: 4px solid var(--ucritter-accent);
      background: #fff;
      padding: 1rem 1.25rem;
      margin-bottom: 2rem;
    }
    .instructions h2 {
      margin-top: 0;
      color: var(--ucritter-primary);
    }
    .warning {
      color: #c62828;
      font-weight: bold;
    }
    button#connect {
      background: var(--ucritter-accent);
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      font-size: 1rem;
      color: #fff;
      cursor: pointer;
    }
    button#connect:hover {
      opacity: 0.9;
    }
  </style>

  <script src="dfu.js"></script>
  <script src="dfuse.js"></script>
  <script src="FileSaver.js"></script>
  <script src="dfu-util.js"></script>
</head>
<body>
  <header class="hero">
    <h1>μCritAir Web Firmware Updater</h1>
    <p class="tagline">Flash your μCritter directly from Chrome — no installs required.</p>
  </header>

  <section class="instructions">
    <h2>Before you begin</h2>
    <ol>
      <li><strong>Use Google Chrome (or any Chromium‑based browser) on a desktop/laptop.</strong> WebUSB is not yet supported on Safari, Firefox, or mobile browsers.</li>
      <li>Connect your μCritAir with a USB‑C cable and click <em>Connect</em> below.</li>
      <li>When prompted, choose the device whose name ends with <code>DFU‑BOOT</code> (Stage&nbsp;1) and authorize it.</li>
      <li>μCritAir will reboot into Stage&nbsp;2 DFU; the page will appear to freeze — this is expected.</li>
      <li>Refresh the page, click <em>Connect</em> again, and authorize the new DFU device (Stage&nbsp;2).</li>
      <li>Refresh once more. Chrome now trusts <em>both</em> stages, so future flashes take a single click.</li>
    </ol>
    <p class="warning">These steps apply to macOS. Windows and Linux instructions are coming soon.</p>
  </section>

  <p style="text-align:center;">
    <button id="connect">Connect</button>
    <span id="status" style="margin-left:1rem;"></span>
  </p>

  <!-- Device dialogs / info -------------------------------------------------- -->
  <dialog id="interfaceDialog">
    Your device exposes multiple DFU interfaces. Select the one you wish to use:
    <form id="interfaceForm" method="dialog">
      <button id="selectInterface" type="submit">Select interface</button>
    </form>
  </dialog>

  <div id="usbInfo" style="white-space: pre; font-size: 0.9rem;"></div>

  <!-- DFU Forms ------------------------------------------------------------- -->
  <fieldset style="margin-top:2rem;">
    <legend>DFU mode</legend>
    <form id="configForm">
      <div id="dfuseFields" hidden>
        <label for="dfuseStartAddress">DfuSe Start Address:</label>
        <input type="text" name="dfuseStartAddress" id="dfuseStartAddress" size="10" pattern="0x[A-Fa-f0-9]+" title="Initial memory address (hex)" />
        <label for="dfuseUploadSize">DfuSe Upload Size:</label>
        <input type="number" name="dfuseUploadSize" id="dfuseUploadSize" min="1" />
      </div>

      <fieldset>
        <legend>Firmware Download (write to device)</legend>
        <!-- File picker can be enabled once the backend supports it
        <p><input type="file" id="firmwareFile" name="file" /></p>
        <p><button id="download" disabled>Download</button></p> -->
        <div class="log" id="downloadLog"></div>
      </fieldset>
    </form>
  </fieldset>

  <footer style="text-align:center; margin-top:3rem; font-size:0.9rem;">
    <p><a href="https://ucritter.com">Back to μCritAir.com</a> • <a href="https://docs.ucritter.com">Documentation</a></p>
  </footer>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>μCritAir WebDFU</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Theme & typography -->
    <link rel="stylesheet" href="sakura.css" />

    <style>
      :root {
        --ucritter-primary: #ff7e3f;  /* vibrant orange */
        --ucritter-accent:  #ffb15e;  /* light‑orange accent */
        --ucritter-bg:      #ffffff;
        --ucritter-text:    #333333;
      }

      /* ---------- layout ---------- */
      body {
        background: var(--ucritter-bg);
        color: var(--ucritter-text);
        max-width: 75rem;
        width: 90%;
        margin: 0 auto;
        padding: 1rem 2rem 4rem;
        font-family: system-ui, -apple-system, "Helvetica Neue", Arial, sans-serif;
      }

      a { color: var(--ucritter-primary); }

      /* ---------- hero ---------- */
      .hero {
        text-align: center;
        padding: 1rem 0 2rem;
      }
      .hero h1 {
        font-size: 2.75rem;
        color: var(--ucritter-primary);
        margin: 0 0 0.5rem;
      }
      .hero .tagline { font-size: 1.25rem; color: #686868; }

      /* ---------- flash box ---------- */
      #flashSection {
        border: 1px solid #ececec;
        border-radius: 8px;
        background: #fafafa;
        padding: 2rem 1.5rem;
        margin-bottom: 2.5rem;
      }
      #flashSection h2 {
        margin-top: 0;
        color: var(--ucritter-primary);
        text-align: center;
      }
      button#connect {
        background: var(--ucritter-primary);
        border: none;
        padding: 0.9rem 1.8rem;
        border-radius: 8px;
        font-size: 1.1rem;
        color: #fff;
        cursor: pointer;
        transition: opacity 0.2s ease;
      }
      button#connect:hover   { opacity: 0.92; }
      button#connect:disabled{ opacity: 0.5;  cursor: not-allowed; }

      #usbInfo { white-space: pre-wrap; font-size: 0.9rem; margin-top: 1rem; }

      fieldset {
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 1rem 1.25rem;
        margin-top: 1.5rem;
      }
      legend { font-weight: 600; color: var(--ucritter-primary); }

      /* ---------- instructions ---------- */
      .instructions {
        border-left: 4px solid var(--ucritter-accent);
        background: #fffefc;
        padding: 1.25rem 1.5rem;
      }
      .warning {
        color: #d32f2f;
        font-weight: 700;
        font-size: 1.1rem;
      }

      /* ---------- OS toggle ---------- */
      .os-toggle { text-align: center; margin: 1rem 0; }
      .os-btn {
        background: none;
        border: 2px solid var(--ucritter-primary);
        color: var(--ucritter-primary);
        padding: 0.4rem 1rem;
        margin: 0 0.25rem;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.2s ease;
      }
      .os-btn.active,
      .os-btn:hover { background: var(--ucritter-primary); color: #fff; }

      /* ---------- browser notice ---------- */
      #browserNotice {
        background: #fff8e6;
        border: 2px solid var(--ucritter-primary);
        padding: 1.5rem 1.25rem;
        border-radius: 8px;
        margin: 1.5rem 0 2rem;
        text-align: center;
        font-size: 1.25rem;
        font-weight: 600;
      }
      #browserNotice .download-btn {
        display: inline-block;
        margin-top: 0.75rem;
        background: var(--ucritter-primary);
        color: #fff;
        padding: 0.6rem 1.2rem;
        border-radius: 6px;
        text-decoration: none;
        font-size: 1rem;
      }

      /* ---------- inline kbd ---------- */
      kbd {
        background: #eee;
        border: 1px solid #ccc;
        border-radius: 3px;
        padding: 0 0.25rem;
        font-size: 0.9em;
      }
    </style>

    <!-- DFU helper libs -->
    <script src="dfu.js"></script>
    <script src="dfuse.js"></script>
    <script src="FileSaver.js"></script>
    <script src="dfu-util.js"></script>

    <script>
      // --------------------------------------------------
      // Browser + OS detection helpers
      // --------------------------------------------------
      const ua             = navigator.userAgent;
      const isChromeDesk   = /Chrome\//.test(ua) && !/OPR|Edg\//.test(ua) && !/(Android|iPhone|iPad|Mobile)/i.test(ua);
      let   detectedOS     = /Win/.test(ua) ? "win" : /Linux/.test(ua) ? "linux" : "mac";

      document.addEventListener("DOMContentLoaded", () => {
        // ---- Show notice if not on Chrome desktop ----
        if (!isChromeDesk) {
          const notice = document.createElement("div");
          notice.id    = "browserNotice";
          notice.innerHTML = `
            <p><strong>You need Google Chrome on a desktop/laptop</strong></p>
            <p>WebUSB only works in Chrome on desktop for now.</p>
            <a class="download-btn" href="https://www.google.com/chrome/" target="_blank" rel="noopener">Download Chrome</a>`;
          document.body.prepend(notice);
          document.getElementById("connect").disabled = true;
        }

        // ---- Highlight & reveal OS instructions ----
        switchOS(detectedOS);
        document.querySelector(`.os-btn[data-os="${detectedOS}"]`).classList.add("active");

        document.querySelectorAll('.os-btn').forEach(btn =>
          btn.addEventListener('click', (e) => {
            document.querySelectorAll('.os-btn').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            switchOS(e.target.dataset.os);
          })
        );
      });

      function switchOS(os) {
        document.querySelectorAll('[data-ins]').forEach(sec => (sec.hidden = true));
        const current = document.querySelector(`[data-ins="${os}"]`);
        if (current) current.hidden = false;
      }
    </script>
  </head>

  <body>
    <!-- ================================================= -->
    <!-- HERO                                               -->
    <!-- ================================================= -->
    <header class="hero">
      <h1>μCritAir Web Firmware Updater</h1>
      <p class="tagline">Flash your μCritter straight from Chrome — no installer required.</p>
    </header>

    <!-- ================================================= -->
    <!-- FLASH UI                                           -->
    <!-- ================================================= -->
    <section id="flashSection" class="box">
      <h2>Flash your device</h2>
      <p style="text-align: center;">
        <button id="connect">Connect</button>
        <span id="status" style="margin-left: 0.75rem"></span>
      </p>

      <!-- multi‑interface dialog -->
      <dialog id="interfaceDialog">
        Your device exposes multiple DFU interfaces.
        <form id="interfaceForm" method="dialog">
          <button id="selectInterface" type="submit">Select interface</button>
        </form>
      </dialog>

      <!-- USB & DFU info log -->
      <div id="usbInfo"></div>

      <!-- DFU controls -->
      <fieldset>
        <legend>DFU mode</legend>
        <form id="configForm">
          <div id="dfuseFields" hidden>
            <label>
              DfuSe Start Address:
              <input type="text" id="dfuseStartAddress" size="10" pattern="0x[A-Fa-f0-9]+" />
            </label>
            <label>
              DfuSe Upload Size:
              <input type="number" id="dfuseUploadSize" min="1" />
            </label>
          </div>

          <fieldset>
            <legend>Firmware Download (write to device)</legend>
            <div class="log" id="downloadLog"></div>
          </fieldset>
        </form>
      </fieldset>
    </section>

    <!-- ================================================= -->
    <!-- OS TOGGLE                                          -->
    <!-- ================================================= -->
    <div class="os-toggle">
      <span>Select your OS:</span>
      <button class="os-btn" data-os="mac">macOS</button>
      <button class="os-btn" data-os="win">Windows</button>
      <button class="os-btn" data-os="linux">Linux</button>
    </div>

    <!-- ================================================= -->
    <!-- INSTRUCTIONS                                       -->
    <!-- ================================================= -->
    <section class="instructions" data-ins="mac">
      <h2>Put the μCritter into DFU mode</h2>
      <p>You should see the <strong>DFU Bootloader</strong> menu after one of these actions:</p>
      <ul>
        <li>
          <strong>Hardware reset:</strong>
          Insert a paperclip into the reset hole above the speaker <em>while holding</em>
          <kbd>Start</kbd> + <kbd>Select</kbd> + <kbd>Down</kbd>.
        </li>
        <li>
          <strong>From the menu:</strong>
          Menu → Power → Sleep, then wake the device holding
          <kbd>Start</kbd> + <kbd>Select</kbd> + <kbd>Down</kbd>.
        </li>
        <li>
          <strong>If already asleep:</strong>
          Wake the device while holding <kbd>Start</kbd> + <kbd>Select</kbd> + <kbd>Down</kbd>.
        </li>
      </ul>

      <h2>macOS flashing workflow</h2>
      <ol>
        <li>Click <em>Connect</em>; choose the <code>MCUBOOT</code> device and press <strong>Connect</strong>.</li>
        <li>The page shows “device disconnected / No device found.” Stage 1 rebooted into Stage 2 DFU.</li>
        <li>
          <strong>Refresh</strong>, click <em>Connect</em> again, pick <code>MCUBOOT</code> (Stage 2). A temporary
          <code>STALL</code> error may appear.
        </li>
        <li>
          <strong>Refresh once more</strong>. Both MCUBOOT stages are authorised; Connect now works and you can
          flash firmware.
        </li>
        <li>
          Verify by clicking Chrome’s site‑permissions icon (two stacked circles) — you should see
          <em>two</em> MCUBOOT USB devices.
        </li>
      </ol>
    </section>

    <section class="instructions" data-ins="win" hidden>
      <h2>Windows setup</h2>
      <p class="warning">
        Detailed Windows steps coming soon. DFU‑mode entry is the same as above; use the double‑refresh pattern
        for now.
      </p>
    </section>

    <section class="instructions" data-ins="linux">
      <h2>Linux setup (udev rules required)</h2>
      <p>Web flashing works on Linux once Chrome is granted USB access via a custom <code>udev</code> rule:</p>
      <ol>
        <li>Open a terminal and create the rule file:
          <pre><code>sudo nano /etc/udev/rules.d/51-mcuboot.rules</code></pre>
        </li>
        <li>Paste this single line and save:
          <pre><code>SUBSYSTEM=="usb", ATTR{idVendor}=="2fe3", ATTR{idProduct}=="0100", MODE="0666", GROUP="plugdev"</code></pre>
        </li>
        <li>Reload rules:
          <pre><code>sudo udevadm control --reload-rules</code></pre>
        </li>
        <li>Unplug and re‑plug the μCritter.</li>
      </ol>
      <p>Now follow the same double‑refresh workflow as macOS (<code>MCUBOOT → refresh → MCUBOOT → refresh</code>) and flashing should work.</p>
    </section>

    <!-- ================================================= -->
    <!-- FOOTER                                             -->
    <!-- ================================================= -->
    <footer style="text-align: center; margin-top: 3rem; font-size: 0.9rem;">
      <p>
        <a href="https://ucritter.com">← Back to μCritter.com</a> ·
        <a href="https://docs.ucritter.com">Documentation</a>
      </p>
    </footer>
  </body>
</html>

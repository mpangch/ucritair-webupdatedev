<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>ŒºCritter Firmware Pupdate!</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="sakura.css" />
    <link rel="stylesheet" href="pupdate-styles.css" />

    <script defer src="dfu.js"></script>
    <script defer src="dfuse.js"></script>
    <script defer src="dfu-util.js"></script>
    <script defer src="app.js"></script>

    </head>

  <body>
    <div class="container">
        <div id="browserNotice" hidden></div>
    </div>

    <header class="hero">
      <h1>ŒºCritter Firmware Pupdate!</h1>
      <p class="tagline">Time to teach your buddy some new tricks! Flash the latest firmware directly from your browser.</p>
    </header>

    <div class="container">

        <div id="readFirstWarning" class="note-box read-first-warning">
             <p><strong>Hold Your Critters!</strong> üê¥ Before clicking Flash, please read *all* instructions for your OS below (use buttons to switch). Important info (drivers, refresh steps!) ensures a smooth pupdate.</p>
        </div>

        <div class="layout-wrapper">

            <div class="column flash-column">
                <section id="flashSection" class="card">
                    <h2>Flash Your Critter</h2>
                    <p style="text-align: center;">Connect ŒºCritter in DFU mode (Step 1) & follow prompts!</p>
                    <p style="text-align: center;">
                        <button id="connect" disabled>Loading Firmware...</button>
                        <span id="status" class="status status-info">Initializing...</span>
                    </p>

                    <dialog id="interfaceDialog">
                       <p>Your device has multiple DFU interfaces. Please select one:</p>
                       <form id="interfaceForm" method="dialog">
                           <div id="interfaceRadioButtons"></div>
                           <button id="selectInterface" type="submit">Use This Interface</button>
                           <button type="button" onclick="this.closest('dialog').close('cancelled')">Cancel</button>
                       </form>
                    </dialog>

                    <div id="usbInfo" style="display: none;"></div>

                    <fieldset>
                        <legend>Update Progress</legend>
                        <div id="dfuseFields" hidden>
                            <label> DfuSe Start Address: <input type="text" id="dfuseStartAddress" size="10" pattern="0x[A-Fa-f0-9]+" placeholder="e.g., 0x08000000"/> </label>
                            <label> DfuSe Upload Size: <input type="number" id="dfuseUploadSize" min="1" placeholder="Bytes" /> </label>
                        </div>
                        <form id="configForm"> <div class="log" id="downloadLog">Waiting for device connection...</div>
                        </form>
                    </fieldset>
                </section>
            </div> <div class="column instructions-column">
                <div class="os-toggle card">
                    <span>Show Instructions For:</span>
                    <div>
                        <button class="os-btn" data-os="mac">macOS</button>
                        <button class="os-btn" data-os="win">Windows</button>
                        <button class="os-btn" data-os="linux">Linux</button>
                    </div>
                </div>

                <section id="intro-instructions" class="instructions card">
                    <h2>Step 1: Enter DFU Mode</h2>
                    <div class="note-box" id="dfu-methods-intro">
                        <p><strong>Important:</strong> Your ŒºCritter must be in "Device Firmware Update" (DFU) mode. Use <strong>ONE</strong> method below. Success = <strong>DFU Bootloader</strong> screen.</p>
                    </div>
                    <ul>
                        <li><strong>Paperclip Poke:</strong> Gently press reset hole (above speaker) with paperclip while holding <kbd>Start</kbd> + <kbd>Select</kbd> + <kbd>Down</kbd>. Release paperclip first, then buttons.</li>
                        <li><strong>Sleepy Wake-up:</strong> Wake sleeping Critter by pressing any button WHILE holding <kbd>Start</kbd> + <kbd>Select</kbd> + <kbd>Down</kbd>.</li>
                        <li><strong>Menu Nap:</strong> Go to <code>Power</code> ‚Üí <code>Sleep</code>. Let it sleep, then use "Sleepy Wake-up" method.</li>
                    </ul>
                    <p><strong>Once DFU screen shows, connect ŒºCritter via USB.</strong> Ready for Step 2!</p>
                     <div class="note-box">
                         <p><em>Why the refreshes?</em> ŒºCritter uses a safe two-stage bootloader (MCUBOOT). Your browser needs to connect to both stages, sometimes requiring page refreshes. Follow the prompts next to the Flash button carefully!</p>
                     </div>
                </section>

                <section class="instructions card" data-ins="mac" hidden>
                  <h2>Step 2: macOS Flashing Dance</h2>
                  <p>Mac users, follow the prompts next to the Flash button. It involves a connect-refresh-connect sequence.</p>
                  <ol>
                    <li>Ensure Critter is connected via USB & shows DFU Bootloader screen (Step 1).</li>
                    <li>Click the <strong>Flash Button</strong> in the other column (text may vary).</li>
                    <li>If browser pop-up appears, select <code>MCUBOOT</code>, click <strong>Connect</strong>.
                       <div class="note-box"><strong>Heads Up!</strong> Seeing <code>CAT PROTOTYPE</code>? Not in DFU mode! Redo Step 1.</div>
                    </li>
                    <li>Status message will say when to <strong>Refresh Page</strong> (<kbd>‚åò</kbd>+<kbd>R</kbd>). Do it!</li>
                    <li>After refresh, if prompted, click button again (e.g., "Connect Stage 2"). Select <code>MCUBOOT</code> if pop-up appears.</li>
                    <li>Status message will say when to <strong>Refresh Page AGAIN</strong> (<kbd>‚åò</kbd>+<kbd>R</kbd>). Do it!</li>
                    <li>After final refresh, if prompted, click button again (e.g., "Connect to Flash"). Flashing starts automatically!</li>
                  </ol>
                   <p><strong>Success?</strong> Watch the progress log. "Pupdate Complete!" means it worked! Critter reboots automatically.</p>
                </section>

                <section class="instructions card" data-ins="win" hidden>
                  <h2>Step 2: Windows Driver & Flashing</h2>
                  <p>Windows requires a **mandatory** one-time driver setup with Zadig for **both** DFU stages. Then follow the page prompts.</p>
                  <h3>A. Install WinUSB Driver (Do TWICE!)</h3>
                  <ol>
                      <li><strong>Get Zadig:</strong> Download latest from <a href="https://zadig.akeo.ie/" target="_blank" rel="noopener">zadig.akeo.ie</a>.</li>
                      <li><strong>Critter in DFU (Stage 1):</strong> Ensure Critter shows DFU screen (Step 1) & is connected via USB.</li>
                      <li><strong>Run Zadig (Admin):</strong> Right-click Zadig ‚Üí "Run as administrator".</li>
                      <li><strong>List All Devices:</strong> In Zadig: `Options` menu ‚Üí Check `List All Devices`.</li>
                      <li><strong>Install for Stage 1 (MCUBOOT 2FE3:0100):</strong>
                          <ul><li>Find & select <code>MCUBOOT</code> (USB ID <code>2FE3:0100</code>) in dropdown.</li><li>Ensure driver box shows <code>WinUSB</code>.</li><li>Click large "Replace Driver" / "Install Driver" button. Confirm prompts.</li><li>Close Zadig.</li></ul>
                           <div class="note-box"><strong>Heads Up!</strong> Seeing <code>CAT PROTOTYPE</code>? Not in DFU mode! Redo Step 1 before Zadig.</div>
                      </li>
                      <li><strong>Start Web Flash (Stage 1 Connect):</strong> Click Flash Button here. Select `MCUBOOT` in browser pop-up ‚Üí Connect.</li>
                       <li><strong>Wait for Stage 2 Device:</strong> Page status shows switching. Windows detects new device stage. **WAIT 5-10 seconds.** **DO NOT REFRESH YET!**</li>
                       <li><strong>Install for Stage 2 (MCUBOOT 2FE3:FFFF or 0100):</strong>
                           <ul><li>Re-open Zadig (Admin). `Options` ‚Üí `List All Devices`.</li><li>Find *new* <code>MCUBOOT</code> (USB ID often <code>2FE3:FFFF</code>, sometimes stays <code>2FE3:0100</code>). Select it.</li><li>Ensure <code>WinUSB</code> selected. Click Replace/Install Driver.</li><li>Close Zadig.</li></ul>
                       </li>
                       <li><strong>HARDWARE & BROWSER RESTART (CRITICAL):</strong>
                          <ul>
                              <li><strong>Unplug</strong> ŒºCritter USB.</li>
                              <li>Completely <strong>CLOSE</strong> web browser (all windows/tabs).</li>
                              <li><strong>Re-open</strong> browser, return to this page.</li>
                              <li><strong>Re-plug</strong> ŒºCritter USB (still in DFU mode!).</li>
                          </ul>
                       </li>
                       <li><strong>Follow On-Screen Prompts:</strong> Page reloads. Follow status messages next to Flash button (may prompt Refresh again or Connect Stage 2).</li>
                  </ol>
                  <h3>B. Windows Flashing Dance (After Zadig & Restarts)</h3>
                   <p>With drivers set up, continue following prompts:</p>
                   <ol start="11"> <li>If prompted, click button (e.g., "Connect Stage 2"), select <code>MCUBOOT</code> if needed.</li>
                     <li>Status message says when to <strong>Refresh Page AGAIN</strong> (<kbd>Ctrl</kbd>+<kbd>R</kbd> / F5). Do it!</li>
                     <li>After final refresh, if prompted, click button (e.g., "Connect to Flash"). Flashing starts!</li>
                   </ol>
                   <p>Watch progress log. "Pupdate Complete!" = Success! Critter reboots.</p>
                </section>

                <section class="instructions card" data-ins="linux" hidden>
                  <h2>Step 2: Linux Permissions & Flashing</h2>
                  <p>Linux needs a one-time `udev` rule for access. Then follow page prompts.</p>
                  <h3>A. Create udev Rule (One Time)</h3>
                  <ol>
                    <li><strong>Open Terminal.</strong></li>
                    <li><strong>Create/Edit Rules File:</strong> <code>sudo nano /etc/udev/rules.d/51-mcuboot.rules</code></li>
                    <li><strong>Paste Lines:</strong> Add these two lines exactly:
                      <pre><code class="language-text">SUBSYSTEM=="usb", ATTR{idVendor}=="2fe3", ATTR{idProduct}=="0100", MODE="0666", GROUP="plugdev"
SUBSYSTEM=="usb", ATTR{idVendor}=="2fe3", ATTR{idProduct}=="ffff", MODE="0666", GROUP="plugdev"</code></pre>
                      <div class="note-box"><p><small><strong>User Group:</strong> Most systems add users to `plugdev`. Check with <code>groups $USER</code>. If missing, run <code>sudo usermod -aG plugdev $USER</code>, then **log out & back in**.</small></p></div>
                    </li>
                    <li><strong>Save & Exit Nano:</strong> <kbd>Ctrl</kbd>+<kbd>X</kbd> ‚Üí <kbd>Y</kbd> ‚Üí <kbd>Enter</kbd>.</li>
                    <li><strong>Reload Rules:</strong> <code>sudo udevadm control --reload-rules && sudo udevadm trigger</code></li>
                    <li><strong>(Optional) One-Liner:</strong> Creates file, adds user (if needed), reloads. Run then log out/in if group was added.
                      <pre><code class="language-text" style="font-size: 1.1rem;">echo -e 'SUBSYSTEM=="usb", ATTR{idVendor}=="2fe3", ATTR{idProduct}=="0100", MODE="0666", GROUP="plugdev"\nSUBSYSTEM=="usb", ATTR{idVendor}=="2fe3", ATTR{idProduct}=="ffff", MODE="0666", GROUP="plugdev"' | sudo tee /etc/udev/rules.d/51-mcuboot.rules > /dev/null && sudo usermod -aG plugdev $USER && sudo udevadm control --reload-rules && sudo udevadm trigger && echo "Rule created/updated. Log out/in if you weren't in plugdev group."</code></pre>
                    </li>
                    <li><strong>Re-plug Critter:</strong> Unplug/replug USB (ensure still in DFU mode).</li>
                  </ol>
                  <h3>B. Linux Flashing Dance</h3>
                  <p>With rules applied, follow prompts next to Flash button:</p>
                   <ol start="8"> <li>Critter connected in DFU mode? Rules applied? Good.</li>
                    <li>Click <strong>Flash Button</strong> in other column.</li>
                    <li>If browser pop-up appears, select <code>MCUBOOT</code>, click <strong>Connect</strong>.
                       <div class="note-box"><strong>Heads Up!</strong> Seeing <code>CAT PROTOTYPE</code>? Not in DFU mode! Redo Step 1.</div>
                    </li>
                    <li>Status message says when to <strong>Refresh Page</strong> (<kbd>Ctrl</kbd>+<kbd>R</kbd> / F5). Do it!</li>
                    <li>After refresh, if prompted, click button again (e.g., "Connect Stage 2"). Select <code>MCUBOOT</code> if pop-up appears.</li>
                    <li>Status message says when to <strong>Refresh Page AGAIN</strong> (<kbd>Ctrl</kbd>+<kbd>R</kbd> / F5). Do it!</li>
                    <li>After final refresh, if prompted, click button again (e.g., "Connect to Flash"). Flashing starts!</li>
                  </ol>
                   <p>Watch progress log. "Pupdate Complete!" = Success! Critter reboots.</p>
                </section>

            </div> </div> </div> <footer class="container">
      <p>
        <a href="https://ucritter.com">‚Üê Back to ŒºCritter.com</a> |
        <a href="https://docs.ucritter.com">Critter Docs & Guides</a>
      </p>
      <p><small>Keep your Critter happy with the latest firmware!</small></p>
    </footer>

  </body>
</html>